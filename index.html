<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>BioSynCare Lab</title>
    <link rel="icon" href="external/biosyncare/icons/icon.svg" type="image/svg+xml" />
    <link rel="manifest" href="manifest.json" />
    <link rel="stylesheet" href="styles/main.css" />
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('sw.js');
        });
      }
    </script>
  </head>
  <body class="lab-surface">
    <div class="app-shell">
      <header class="lab-header">
        <div class="lab-brand">
          <p class="brand-eyebrow">BioSynCare</p>
          <h1>BioSynCare Lab</h1>
          <p class="brand-tagline">Sync presets, sessions, tracks, and Martigli telemetry across devices.</p>
          <div style="margin-top: 1rem;">
            <a href="nso-navigator.html" class="ghost small" style="text-decoration: none;">üîç NSO Navigator</a>
          </div>
        </div>
        <div class="lab-auth" id="lab-auth">
          <div id="auth-chip" class="auth-chip hidden" aria-live="polite">
            <div class="auth-chip-details">
              <p class="auth-chip-label">Signed in</p>
              <p id="auth-state" class="auth-chip-state">Checking‚Ä¶</p>
              <p id="user-email" class="auth-chip-email"></p>
              <p id="user-id" class="auth-chip-id"></p>
            </div>
            <button id="status-sign-out" class="ghost small" type="button">Sign out</button>
          </div>
          <div id="auth-forms" class="auth-forms" aria-live="polite">
            <section class="auth-section auth-section--google">
              <div class="auth-section-head">
                <h2>Sign in</h2>
                <p class="muted-text small">Use Google for quickest access.</p>
              </div>
              <div class="auth-actions-row">
                <button id="google-sign-in" class="primary" type="button">Continue with Google</button>
              </div>
              <div class="auth-mode-hint">
                <p id="auth-mode-text" class="muted-text">Checking auth mode‚Ä¶</p>
                <button type="button" id="toggle-auth-mode" class="ghost small hidden">Use production auth</button>
              </div>
            </section>
            <section class="auth-section auth-section--email">
              <div class="auth-section-head">
                <h3>Email access</h3>
                <p class="muted-text small">Use your lab credentials.</p>
              </div>
              <form id="email-form">
                <label>
                  Email
                  <input type="email" id="email" required autocomplete="email" />
                </label>
                <label>
                  Password
                  <input type="password" id="password" required minlength="6" autocomplete="current-password" />
                </label>
                <div class="form-actions">
                  <button type="submit" class="primary">Sign in</button>
                  <button type="button" id="email-sign-up" class="ghost">Create account</button>
                </div>
              </form>
            </section>
          </div>
        </div>
      </header>

      <div id="messages" class="lab-messages" aria-live="polite"></div>

      <nav id="lab-tabs" class="lab-tabs hidden" role="tablist">
        <button type="button" id="tab-dashboard" class="lab-tab active" role="tab" aria-selected="true" aria-controls="panel-dashboard">
          Dashboard
        </button>
        <button type="button" id="tab-structures" class="lab-tab" role="tab" aria-selected="false" aria-controls="panel-structures">
          Structure Explorer
        </button>
        <button type="button" id="tab-nso" class="lab-tab" role="tab" aria-selected="false" aria-controls="panel-nso">
          NSO Navigator
        </button>
      </nav>

      <main id="panel-dashboard" class="lab-main lab-tab-panel hidden" role="tabpanel" aria-labelledby="tab-dashboard" aria-live="polite">
        <section class="lab-panel sessions-panel" id="dashboard-session-card">
          <div class="panel-head">
            <div>
              <p class="panel-eyebrow">Sessions</p>
              <h2>Session library</h2>
              <p id="session-status" class="muted-text">Sign in to load sessions.</p>
            </div>
            <div class="panel-actions">
              <button type="button" id="session-apply" class="ghost tiny">Apply session</button>
              <button type="button" id="session-save" class="ghost tiny">Save current state</button>
              <button type="button" id="session-share-link" class="ghost tiny">Copy share link</button>
              <span id="session-share-indicator" class="badge tiny hidden" aria-live="polite">State in URL</span>
            </div>
          </div>
          <p id="session-card-hint" class="muted-text small">
            Select a record to hydrate Martigli and sensory controls.
          </p>
          <ul id="session-list" class="stack-list"></ul>
          <footer class="panel-footer">
            <button type="button" id="session-navigator" class="ghost small" disabled>
              Open Session Class Navigator
            </button>
          </footer>
        </section>

        <section class="lab-panel sensory-panel" id="dashboard-sensory-card">
          <div class="panel-head">
            <div>
              <p class="panel-eyebrow">Tracks</p>
              <h2>Session tracks</h2>
              <p class="muted-text small">Audio, visual, haptic, and Martigli tracks sourced from the session.</p>
            </div>
          </div>
          <div class="track-grid">
            <section class="track-panel martigli-panel" id="dashboard-martigli-card">
              <div class="section-headline">
                <h3>Martigli tracks</h3>
                <p id="martigli-dashboard-preview" class="muted-text small">
                  Live Martigli widget syncs with your current dashboard session.
                </p>
              </div>
              <div class="panel-actions">
                <button type="button" id="martigli-add-dashboard" class="ghost tiny">Add oscillation</button>
              </div>
              <p id="martigli-dashboard-summary" class="muted-text small">No oscillations yet.</p>
              <div id="martigli-dashboard-list" class="martigli-dashboard-list" aria-live="polite"></div>
            </section>
            <section class="track-panel">
              <div class="section-headline">
                <h3>Audio tracks</h3>
                <p id="audio-sensory-status" class="muted-text">Select a session to preview audio layers.</p>
              </div>
              <div class="panel-actions" style="margin-bottom: 0.5rem; display: flex; gap: 0.5rem; align-items: center;">
                 <select id="audio-track-type" class="tiny" style="width: auto; flex: 1;">
                   <option value="BinauralBeatTrack">Binaural Beat</option>
                   <option value="IsochronicTrack">Isochronic Tone</option>
                   <option value="SineTrack">Sine Wave</option>
                 </select>
                 <button type="button" id="audio-add-track" class="primary tiny">Add</button>
                 <button type="button" id="audio-resume" class="ghost tiny" title="Resume Audio Context">‚ñ∂</button>
              </div>
              <ul id="audio-sensory-list" class="sensory-list"></ul>
            </section>
            <section class="track-panel">
              <div class="section-headline">
                <h3>Visual tracks</h3>
                <p id="visual-sensory-status" class="muted-text">Waiting for a session with video cues.</p>
              </div>
              <div class="panel-actions" style="margin-bottom: 0.5rem; display: flex; gap: 0.5rem; align-items: center;">
                 <select id="visual-track-type" class="tiny" style="width: auto; flex: 1;">
                   <option value="GeometryVisualTrack">Geometry</option>
                   <option value="ParticleVisualTrack">Particles</option>
                 </select>
                 <button type="button" id="visual-add-track" class="primary tiny">Add</button>
              </div>
              <ul id="visual-sensory-list" class="sensory-list"></ul>
            </section>
            <section class="track-panel">
              <div class="section-headline">
                <h3>Haptic tracks</h3>
                <p id="haptic-sensory-status" class="muted-text">Waiting for a session with haptic cues.</p>
              </div>
              <div class="panel-actions" style="margin-bottom: 0.5rem; display: flex; gap: 0.5rem; align-items: center;">
                 <select id="haptic-track-type" class="tiny" style="width: auto; flex: 1;">
                   <option value="VibrationTrack">Vibration</option>
                 </select>
                 <button type="button" id="haptic-add-track" class="primary tiny">Add</button>
              </div>
              <ul id="haptic-sensory-list" class="sensory-list"></ul>
            </section>
          </div>
        </section>
      </main>

      <div id="panel-structures" class="lab-tab-panel hidden" role="tabpanel" aria-labelledby="tab-structures">
        <div class="visualizer-container">
          <header class="visualizer-header">
            <h2>Music Structure Visualizer</h2>
            <p class="muted-text">Explore change-ringing patterns, permutation families, and symmetry structures</p>
          </header>

          <div class="visualizer-controls">
            <div class="control-group">
              <label for="structure-category">Structure Category</label>
              <select id="structure-category">
                <option value="">Select a category...</option>
                <option value="curated">Curated Sequences (Community Alpha, Martigli, Symmetry)</option>
                <option value="comprehensive">Comprehensive Music Structures</option>
              </select>
            </div>

            <div class="control-group" id="structure-select-group" style="display: none;">
              <label for="structure-select">Select Structure</label>
              <select id="structure-select" disabled>
                <option value="">Choose a structure...</option>
              </select>
            </div>
          </div>

          <div id="stats-container"></div>
          <div id="sequence-container"></div>
          <div id="additional-data-container"></div>
        </div>
      </div>

      <div id="panel-nso" class="lab-tab-panel hidden" role="tabpanel" aria-labelledby="tab-nso">
        <div class="visualizer-container">
          <header class="visualizer-header">
            <h2>NSO Navigator</h2>
            <p class="muted-text">Explore the Neurosensory Stimulation Ontology and semantic structures</p>
          </header>

          <div class="nso-content">
            <p class="muted-text">NSO Navigator integration coming soon. This will provide:</p>
            <ul>
              <li>Semantic graph visualization</li>
              <li>Concept relationships and properties</li>
              <li>RDF data browser</li>
              <li>Links to musical structures and session concepts</li>
            </ul>
            <p class="muted-text" style="margin-top: 1rem;">
              For now, visit <a href="nso-navigator.html" target="_blank">NSO Navigator</a> as a separate page.
            </p>
          </div>
        </div>
      </div>
    </div>

    <section id="detail-modal" class="modal hidden" aria-hidden="true">
      <div id="modal-overlay" class="modal-overlay" role="presentation"></div>
      <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <header class="modal-head">
          <div>
            <p id="modal-kind" class="muted-text"></p>
            <h3 id="modal-title"></h3>
          </div>
          <button type="button" id="modal-close" class="ghost small" aria-label="Close dialog">Close</button>
        </header>

        <section aria-labelledby="modal-meta-label">
          <h4 id="modal-meta-label">Summary</h4>
          <dl id="modal-meta" class="modal-meta"></dl>
        </section>

        <section class="modal-card" id="martigli-card" aria-labelledby="martigli-card-label">
          <div class="section-head">
            <div>
              <h4 id="martigli-card-label">Martigli / Breathing Oscillations</h4>
              <p id="martigli-preview" class="muted-text"></p>
            </div>
          </div>
          <div class="martigli-oscillation-toolbar">
            <label for="martigli-oscillation-select">Active oscillation</label>
            <div class="martigli-oscillation-actions">
              <select id="martigli-oscillation-select"></select>
              <div class="martigli-oscillation-buttons">
                <button type="button" id="martigli-add" class="ghost tiny">Add</button>
                <button type="button" id="martigli-rename" class="ghost tiny">Rename</button>
                <button type="button" id="martigli-delete" class="ghost tiny">Delete</button>
              </div>
            </div>
            <p id="martigli-oscillation-status" class="muted-text small"></p>
          </div>
          <div class="martigli-card-grid">
            <div>
              <h5>Stored parameters</h5>
              <div id="modal-martigli" class="martigli-params"></div>
            </div>
            <div class="martigli-visual">
              <h5>Visual preview</h5>
              <canvas id="martigli-canvas" width="360" height="160" aria-label="Martigli waveform preview"></canvas>
              <p class="muted-text">Canvas pulses with the current Martigli snapshot; video engines will hook here.</p>
            </div>
          </div>
          <p class="muted-text small">
            Live Martigli controls are available directly on the Martigli / Breathing Oscillations dashboard card.
          </p>
        </section>

        <section class="modal-card" id="audio-card" aria-labelledby="audio-card-label">
          <div class="section-head">
            <div>
              <h4 id="audio-card-label">Audio tracks</h4>
              <p id="audio-track-hint" class="muted-text"></p>
            </div>
          </div>
          <ul id="audio-track-list" class="track-list"></ul>
        </section>

        <section class="modal-card" id="video-card" aria-labelledby="video-card-label">
          <div class="section-head">
            <div>
              <h4 id="video-card-label">Visual controls</h4>
              <p id="video-track-hint" class="muted-text">No video tracks stored yet.</p>
            </div>
          </div>
          <ul id="video-track-list" class="track-list"></ul>
        </section>

        <section class="modal-card" id="haptics-card" aria-labelledby="haptics-card-label">
          <div class="section-head">
            <div>
              <h4 id="haptics-card-label">Haptic controls</h4>
              <p id="haptic-track-hint" class="muted-text">No haptic tracks stored yet.</p>
            </div>
          </div>
          <ul id="haptic-track-list" class="track-list"></ul>
        </section>

        <section class="modal-card" id="structure-section" aria-labelledby="structure-label">
          <div class="section-head">
            <div>
              <h4 id="structure-label">Change-Ringing Structures</h4>
              <p id="structure-summary" class="muted-text"></p>
            </div>
          </div>
          <ul id="structure-list" class="structure-list"></ul>
        </section>
      </div>
    </section>

    <section id="visualizer-modal" class="modal hidden" aria-hidden="true">
      <div id="visualizer-overlay" class="modal-overlay" role="presentation"></div>
      <div class="modal-panel visualizer-panel" role="dialog" aria-modal="true" aria-labelledby="visualizer-title">
        <header class="modal-head">
          <h3 id="visualizer-title">Track Preview</h3>
          <button type="button" id="visualizer-close" class="ghost small" aria-label="Close visualizer">Close</button>
        </header>
        <canvas id="visualizer-canvas" width="760" height="280" aria-label="Expanded track visualization"></canvas>
        <p id="visualizer-summary" class="muted-text small"></p>
      </div>
    </section>

    <script type="module" src="scripts/auth.js"></script>
  </body>
</html>
