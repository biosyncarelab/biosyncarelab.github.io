<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>BioSynCare Lab</title>
    <link rel="icon" href="external/biosyncare/icons/icon.svg" type="image/svg+xml" />
    <link rel="manifest" href="manifest.json" />
    <link rel="stylesheet" href="styles/main.css" />
    <link rel="stylesheet" href="styles/nso-navigator.css" />
    <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('sw.js');
        });
      }
    </script>
  </head>
  <body class="lab-surface">
    <div class="app-shell">
      <header class="lab-header">
        <div class="lab-brand">
          <p class="brand-eyebrow">BioSynCare</p>
          <h1>BioSynCare Lab</h1>
          <p class="brand-tagline">Sync presets, sessions, tracks, and Martigli telemetry across devices.</p>
        </div>
        <div class="lab-auth" id="lab-auth">
          <div id="auth-chip" class="auth-chip hidden" aria-live="polite">
            <div class="auth-chip-details">
              <p class="auth-chip-label">Signed in</p>
              <p id="auth-state" class="auth-chip-state">Checking‚Ä¶</p>
              <p id="user-email" class="auth-chip-email"></p>
              <p id="user-id" class="auth-chip-id"></p>
            </div>
            <button id="status-sign-out" class="ghost small" type="button">Sign out</button>
          </div>
          <div id="auth-forms" class="auth-forms" aria-live="polite">
            <section class="auth-section auth-section--google">
              <div class="auth-section-head">
                <h2>Sign in</h2>
                <p class="muted-text small">Use Google for quickest access.</p>
              </div>
              <div class="auth-actions-row">
                <button id="google-sign-in" class="primary" type="button">Continue with Google</button>
              </div>
              <div class="auth-mode-hint">
                <p id="auth-mode-text" class="muted-text">Checking auth mode‚Ä¶</p>
                <button type="button" id="toggle-auth-mode" class="ghost small hidden">Use production auth</button>
              </div>
            </section>
            <section class="auth-section auth-section--email">
              <div class="auth-section-head">
                <h3>Email access</h3>
                <p class="muted-text small">Use your lab credentials.</p>
              </div>
              <form id="email-form">
                <label>
                  Email
                  <input type="email" id="email" required autocomplete="email" />
                </label>
                <label>
                  Password
                  <input type="password" id="password" required minlength="6" autocomplete="current-password" />
                </label>
                <div class="form-actions">
                  <button type="submit" class="primary">Sign in</button>
                  <button type="button" id="email-sign-up" class="ghost">Create account</button>
                </div>
              </form>
            </section>
          </div>
        </div>
      </header>

      <div id="messages" class="lab-messages" aria-live="polite"></div>

      <!-- RDF Tooltip -->
      <div id="rdf-tooltip" class="rdf-tooltip hidden">
        <div class="rdf-tooltip-content">
          <strong id="rdf-tooltip-term">Term</strong>
          <span class="rdf-tooltip-hint">Click to navigate</span>
        </div>
      </div>

      <nav id="lab-tabs" class="lab-tabs hidden" role="tablist">
        <button type="button" id="tab-dashboard" class="lab-tab active" role="tab" aria-selected="true" aria-controls="panel-dashboard">
          Dashboard
        </button>
                <button type="button" id="tab-structures" class="lab-tab" role="tab" aria-selected="false" aria-controls="panel-structures">
          Structure Explorer
        </button>
        <button type="button" id="tab-nso" class="lab-tab" role="tab" aria-selected="false" aria-controls="panel-nso">
          NSO Navigator
        </button>
      </nav>

      <main id="panel-dashboard" class="lab-main lab-tab-panel hidden" role="tabpanel" aria-labelledby="tab-dashboard" aria-live="polite">
        <section class="lab-panel sessions-panel" id="dashboard-session-card">
          <div class="panel-head">
            <div>
              <p class="panel-eyebrow">Sessions</p>
              <h2>Session library</h2>
              <p id="session-status" class="muted-text">Sign in to load sessions.</p>
            </div>
            <div class="panel-actions">
              <button type="button" id="session-apply" class="ghost tiny">Apply session</button>
              <button type="button" id="session-save" class="ghost tiny">Save current state</button>
              <button type="button" id="session-share-link" class="ghost tiny">Copy share link</button>
              <button type="button" id="snapshot-download" class="ghost tiny">Download snapshot</button>
              <span id="session-share-indicator" class="badge tiny hidden" aria-live="polite">State in URL</span>
            </div>
          </div>
          <p id="session-card-hint" class="muted-text small">
            Select a record to hydrate Martigli and sensory controls.
          </p>
          <ul id="session-list" class="stack-list"></ul>
          <footer class="panel-footer">
            <button type="button" id="session-navigator" class="ghost small" disabled>
              Open Session Class Navigator
            </button>
          </footer>
        </section>

        <section class="lab-panel sensory-panel" id="dashboard-sensory-card">
          <div class="panel-head">
            <div>
              <p class="panel-eyebrow">Tracks</p>
              <h2>Session tracks</h2>
              <p class="muted-text small">Audio, visual, haptic, and Martigli tracks sourced from the session.</p>
            </div>
          </div>
          <div class="track-grid">
            <section class="track-panel martigli-panel" id="dashboard-martigli-card">
              <div class="section-headline">
                <h3>Martigli tracks</h3>
                <p id="martigli-dashboard-preview" class="muted-text small">
                  Live Martigli widget syncs with your current dashboard session.
                </p>
              </div>
              <div class="panel-actions">
                <button type="button" id="martigli-add-dashboard" class="ghost tiny">Add oscillation</button>
              </div>
              <p id="martigli-dashboard-summary" class="muted-text small">No oscillations yet.</p>
              <div id="martigli-dashboard-list" class="martigli-dashboard-list" aria-live="polite"></div>
            </section>
            <section class="track-panel">
              <div class="section-headline">
                <h3>Audio tracks</h3>
                <p id="audio-sensory-status" class="muted-text">Select a session to preview audio layers.</p>
              </div>
              <div class="panel-actions" style="margin-bottom: 0.5rem; display: flex; gap: 0.5rem; align-items: center;">
                 <select id="audio-track-type" class="tiny" style="width: auto; flex: 1;">
                   <option value="BinauralBeatTrack">Binaural Beat</option>
                   <option value="IsochronicTrack">Isochronic Tone</option>
                   <option value="SineTrack">Sine Wave</option>
                 </select>
                 <button type="button" id="audio-add-track" class="primary tiny">Add</button>
                 <button type="button" id="audio-resume" class="ghost tiny" title="Resume Audio Context">‚ñ∂</button>
              </div>
              <ul id="audio-sensory-list" class="sensory-list"></ul>
            </section>
            <section class="track-panel">
              <div class="section-headline">
                <h3>Visual tracks</h3>
                <p id="visual-sensory-status" class="muted-text">Waiting for a session with video cues.</p>
              </div>
              <div class="panel-actions" style="margin-bottom: 0.5rem; display: flex; gap: 0.5rem; align-items: center;">
                 <select id="visual-track-type" class="tiny" style="width: auto; flex: 1;">
                   <option value="GeometryVisualTrack">Geometry</option>
                   <option value="ParticleVisualTrack">Particles</option>
                 </select>
                 <button type="button" id="visual-add-track" class="primary tiny">Add</button>
              </div>
              <ul id="visual-sensory-list" class="sensory-list"></ul>
            </section>
            <section class="track-panel">
              <div class="section-headline">
                <h3>Haptic tracks</h3>
                <p id="haptic-sensory-status" class="muted-text">Waiting for a session with haptic cues.</p>
              </div>
              <div class="panel-actions" style="margin-bottom: 0.5rem; display: flex; gap: 0.5rem; align-items: center;">
                 <select id="haptic-track-type" class="tiny" style="width: auto; flex: 1;">
                   <option value="VibrationTrack">Vibration</option>
                 </select>
                 <button type="button" id="haptic-add-track" class="primary tiny">Add</button>
              </div>
              <ul id="haptic-sensory-list" class="sensory-list"></ul>
            </section>
          </div>
        </section>
      </main>

      <div id="panel-structures" class="lab-tab-panel hidden" role="tabpanel" aria-labelledby="tab-structures">
        <div class="visualizer-container">
          <header class="visualizer-header">
            <h2>Music Structure Visualizer</h2>
            <p class="muted-text">Explore change-ringing patterns, permutation families, and symmetry structures</p>
          </header>

          <div class="visualizer-controls">
            <div class="control-group">
              <label for="structure-category">Structure Category</label>
              <select id="structure-category">
                <option value="">Select a category...</option>
                <option value="curated">Curated Sequences (Community Alpha, Martigli, Symmetry)</option>
                <option value="comprehensive">Comprehensive Music Structures</option>
              </select>
            </div>

            <div class="control-group" id="structure-select-group" style="display: none;">
              <label for="structure-select">Select Structure</label>
              <select id="structure-select" disabled>
                <option value="">Choose a structure...</option>
              </select>
            </div>
          </div>

          <div id="stats-container"></div>
          <div id="sequence-container"></div>
          <div id="additional-data-container"></div>
        </div>
      </div>

      <div id="panel-nso" class="lab-tab-panel hidden" role="tabpanel" aria-labelledby="tab-nso">
        <div class="nso-wrapper">
            <header class="nso-header">
              <div class="nso-header-content">
                <h2>NSO Navigator</h2>
                <p class="muted-text">Neurosensory Stimulation Ontology Browser</p>
              </div>
              <div class="nso-header-controls">
                <select id="ontology-selector" class="ontology-selector" title="Select an ontology to visualize">
                  <optgroup label="‚îÅ‚îÅ‚îÅ Main Ontologies ‚îÅ‚îÅ‚îÅ">
                    <option value="bsc-consolidated" data-description="Complete: 60+ classes across audio, visual, multimodal techniques and outcomes (evidence 0-5 scale)">
                      NSO Consolidated v1.0
                    </option>
                    <option value="bsc-audio" data-description="6 audio techniques: binaural/monaural beats, isochronic, solfeggio (evidence 0.5-2.5)">
                      Audio Techniques
                    </option>
                    <option value="bsc-visual" data-description="7 visual: flicker, color, entrainment, Ganzfeld (evidence 1.2-3.8, epilepsy warnings)">
                      Visual Techniques
                    </option>
                    <option value="bsc-mixed" data-description="9 multimodal: audiovisual, vibroacoustic, VR, haptic (evidence 1.5-3.5)">
                      Multimodal Techniques
                    </option>
                    <option value="bsc-martigli" data-description="Martigli oscillation parameters: waveforms, periods, inhale ratios, and configuration metadata">
                      Martigli Breathing
                    </option>
                    <option value="bsc-outcomes" data-description="30+ outcomes: cognitive, emotional, physiological, behavioral with measurement standards" selected>
                      Outcomes Taxonomy
                    </option>
                  </optgroup>
                  <optgroup label="‚îÅ‚îÅ‚îÅ Core & Legacy ‚îÅ‚îÅ‚îÅ">
                    <option value="bsc-owl" data-description="Core classes (Project, Session, Technique, Outcome) + 11 safety/evidence properties">
                      BSC Core (OWL)
                    </option>
                    <option value="bsc-skos" data-description="SKOS concept schemes for neurosensory stimulation">
                      BSC Core (SKOS)
                    </option>
                    <option value="sso-ontology" data-description="External: Sensory Stimulation Ontology (legacy)">
                      SSO Ontology (legacy)
                    </option>
                    <option value="sso-extended" data-description="External: Extended SSO (legacy)">
                      SSO Extended (legacy)
                    </option>
                    <option value="sso-initial" data-description="External: SSO with hierarchies (legacy)">
                      SSO Initial (legacy)
                    </option>
                    <option value="sso-updated" data-description="External: Updated SSO (legacy)">
                      SSO Updated (legacy)
                    </option>
                    <option value="onc-ontology" data-description="External: Neurosensory Care Ontology (legacy)">
                      ONC Ontology (legacy)
                    </option>
                    <option value="onc-attachment" data-description="External: ONC with hierarchies (legacy)">
                      ONC Attachment (legacy)
                    </option>
                    <option value="harmonicare-sso" data-description="External: HarmoniCare SSO variant (legacy)">
                      HarmoniCare SSO (legacy)
                    </option>
                    <option value="harmonicare-sso-alt" data-description="External: HarmoniCare SSO alt (legacy)">
                      HarmoniCare SSO Alt (legacy)
                    </option>
                  </optgroup>
                </select>
                <div id="ontology-description" class="ontology-description" style="font-size: 0.85em; color: #666; margin-top: 4px; max-width: 600px;"></div>
                <select id="layout-selector" class="layout-selector">
                  <option value="cose">Force-Directed (COSE)</option>
                  <option value="circle">Circle</option>
                  <option value="concentric">Concentric</option>
                  <option value="breadthfirst">Breadth-First Tree</option>
                  <option value="grid">Grid</option>
                  <option value="cose-bilkent">COSE-Bilkent (Compound)</option>
                </select>
                <button type="button" id="reset-view" class="ghost small">Reset View</button>
              </div>
            </header>

            <!-- Inline Semantic & Edge Filters Row -->
            <div class="filter-row">
              <div class="filter-block">
                <div class="filter-label">üìä Evidence</div>
                <div class="filter-control">
                  <input type="range" id="evidence-level-slider" min="0" max="5" step="0.1" value="0" />
                  <span class="filter-note"><span id="evidence-level-value">0.0+</span>/5</span>
                </div>
              </div>

              <div class="filter-block">
                <div class="filter-label">‚ö†Ô∏è Safety</div>
                <label class="filter-checkbox inline">
                  <input type="checkbox" id="filter-serious-warnings" />
                  <span>Hide SERIOUS</span>
                </label>
                <label class="filter-checkbox inline">
                  <input type="checkbox" id="filter-safe-only" />
                  <span>Safe only</span>
                </label>
              </div>

              <div class="filter-block">
                <div class="filter-label">üéµ Modality</div>
                <label class="filter-checkbox inline">
                  <input type="checkbox" id="filter-audio" checked />
                  <span>Audio</span>
                </label>
                <label class="filter-checkbox inline">
                  <input type="checkbox" id="filter-visual" checked />
                  <span>Visual</span>
                </label>
                <label class="filter-checkbox inline">
                  <input type="checkbox" id="filter-mixed" checked />
                  <span>Mixed</span>
                </label>
              </div>

              <div class="filter-block">
                <div class="filter-label">üéØ Outcomes</div>
                <label class="filter-checkbox inline">
                  <input type="checkbox" id="filter-cognitive" checked />
                  <span>Cognitive</span>
                </label>
                <label class="filter-checkbox inline">
                  <input type="checkbox" id="filter-emotional" checked />
                  <span>Emotional</span>
                </label>
                <label class="filter-checkbox inline">
                  <input type="checkbox" id="filter-physiological" checked />
                  <span>Physiological</span>
                </label>
                <label class="filter-checkbox inline">
                  <input type="checkbox" id="filter-behavioral" checked />
                  <span>Behavioral</span>
                </label>
              </div>

              <div class="filter-block">
                <div class="filter-label">üß≠ Other Entities</div>
                <label class="filter-checkbox inline">
                  <input type="checkbox" id="filter-protocol" checked />
                  <span>Protocols/Sessions/Reports</span>
                </label>
                <label class="filter-checkbox inline">
                  <input type="checkbox" id="filter-group" checked />
                  <span>Participant Groups</span>
                </label>
                <label class="filter-checkbox inline">
                  <input type="checkbox" id="filter-other-meta" checked />
                  <span>Other Admin/Meta</span>
                </label>
              </div>

              <div class="filter-block">
                <div class="filter-label">üï∏Ô∏è Edges</div>
                <div id="edge-filters" class="edge-inline">
                  <label class="filter-checkbox inline">
                    <input type="checkbox" id="filter-subclass" checked />
                    <span>Subclass/Hierarchy</span>
                  </label>
                  <label class="filter-checkbox inline">
                    <input type="checkbox" id="filter-object" checked />
                    <span>Object Properties</span>
                  </label>
                  <label class="filter-checkbox inline">
                    <input type="checkbox" id="filter-data" checked />
                    <span>Data Properties</span>
                  </label>
                  <label class="filter-checkbox inline">
                    <input type="checkbox" id="filter-skos" checked />
                    <span>SKOS (broader/narrower/related)</span>
                  </label>
                </div>
              </div>

              <div class="filter-block">
                <div class="filter-label">‚öôÔ∏è View</div>
                <button type="button" id="toggle-properties" class="ghost small">
                  <span id="properties-toggle-text">Hide Properties</span>
                </button>
                <button type="button" id="select-all-filters" class="ghost small">Select All</button>
                <button type="button" id="invert-filters" class="ghost small">Invert</button>
                <button type="button" id="reset-filters" class="ghost small">Reset Filters</button>
              </div>
            </div>
            <div id="filter-status" class="filter-status" aria-live="polite"></div>

            <div class="nso-container">
              <aside id="uri-inspector" class="uri-inspector hidden">
                <div class="inspector-header">
                  <h2 id="inspector-title">URI Inspector</h2>
                  <button type="button" id="close-inspector" class="ghost small" aria-label="Close inspector">√ó</button>
                </div>

                <div class="inspector-content">
                  <section class="inspector-section">
                    <h3>URI</h3>
                    <code id="inspector-uri" class="uri-display"></code>
                  </section>

                  <section class="inspector-section">
                    <h3>Type</h3>
                    <p id="inspector-type" class="type-badge"></p>
                  </section>

                  <section class="inspector-section">
                    <h3>Label</h3>
                    <p id="inspector-label"></p>
                  </section>

                  <section class="inspector-section">
                    <h3>Definition</h3>
                    <p id="inspector-definition" class="muted-text"></p>
                  </section>

                  <section class="inspector-section">
                    <h3>Properties</h3>
                    <dl id="inspector-properties" class="property-list"></dl>
                  </section>

                  <section class="inspector-section">
                    <h3>Comments</h3>
                    <div id="inspector-comments" class="comments-list"></div>
                    <button type="button" id="add-comment-btn" class="ghost small">+ Add Comment</button>

                    <form id="comment-form" class="comment-form hidden">
                      <textarea
                        id="comment-input"
                        placeholder="Add your comment or annotation..."
                        rows="3"
                        required
                      ></textarea>
                      <div class="form-actions">
                        <button type="submit" class="primary small">Save</button>
                        <button type="button" id="cancel-comment" class="ghost small">Cancel</button>
                      </div>
                    </form>
                  </section>
                </div>
              </aside>

              <main class="graph-container">
                <div id="cy-canvas" class="cy-canvas"></div>

                <div class="graph-legend">
                  <h4>Legend</h4>
                  <div class="legend-items">
                    <div class="legend-section">
                      <strong>Nodes</strong>
                      <div class="legend-item">
                        <span class="legend-color" style="background: #38bdf8"></span>
                        <span>Class</span>
                      </div>
                      <div class="legend-item">
                        <span class="legend-color" style="background: #22d3ee"></span>
                        <span>Concept</span>
                      </div>
                      <div class="legend-item">
                        <span class="legend-color" style="background: #a78bfa"></span>
                        <span>Object Property</span>
                      </div>
                      <div class="legend-item">
                        <span class="legend-color" style="background: #fb923c"></span>
                        <span>Data Property</span>
                      </div>
                    </div>
                    <div class="legend-section">
                      <strong>Edges</strong>
                      <div class="legend-item">
                        <span class="legend-arrow subclass"></span>
                        <span>Subclass/Hierarchy</span>
                      </div>
                      <div class="legend-item">
                        <span class="legend-arrow domain"></span>
                        <span>Domain</span>
                      </div>
                      <div class="legend-item">
                        <span class="legend-arrow range"></span>
                        <span>Range</span>
                      </div>
                      <div class="legend-item">
                        <span class="legend-arrow related"></span>
                        <span>Related/Other</span>
                      </div>
                    </div>
                  </div>
                </div>

                <div id="loading-indicator" class="loading-indicator">
                  <p>Loading ontology...</p>
                </div>

                <div id="error-message" class="error-message hidden">
                  <p id="error-text"></p>
                </div>
              </main>
            </div>
        </div>
      </div>
    </div>

    <section id="detail-modal" class="modal hidden" aria-hidden="true">
      <div id="modal-overlay" class="modal-overlay" role="presentation"></div>
      <div class="modal-panel" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <header class="modal-head">
          <div>
            <p id="modal-kind" class="muted-text"></p>
            <h3 id="modal-title"></h3>
          </div>
          <button type="button" id="modal-close" class="ghost small" aria-label="Close dialog">Close</button>
        </header>

        <section aria-labelledby="modal-meta-label">
          <h4 id="modal-meta-label">Summary</h4>
          <dl id="modal-meta" class="modal-meta"></dl>
        </section>

        <section class="modal-card" id="martigli-card" aria-labelledby="martigli-card-label">
          <div class="section-head">
            <div>
              <h4 id="martigli-card-label">Martigli / Breathing Oscillations</h4>
              <p id="martigli-preview" class="muted-text"></p>
            </div>
          </div>
          <div class="martigli-oscillation-toolbar">
            <label for="martigli-oscillation-select">Active oscillation</label>
            <div class="martigli-oscillation-actions">
              <select id="martigli-oscillation-select"></select>
              <div class="martigli-oscillation-buttons">
                <button type="button" id="martigli-add" class="ghost tiny">Add</button>
                <button type="button" id="martigli-rename" class="ghost tiny">Rename</button>
                <button type="button" id="martigli-delete" class="ghost tiny">Delete</button>
              </div>
            </div>
            <p id="martigli-oscillation-status" class="muted-text small"></p>
          </div>
          <div class="martigli-card-grid">
            <div>
              <h5>Stored parameters</h5>
              <div id="modal-martigli" class="martigli-params"></div>
            </div>
            <div class="martigli-visual">
              <h5>Visual preview</h5>
              <canvas id="martigli-canvas" width="360" height="160" aria-label="Martigli waveform preview"></canvas>
              <p class="muted-text">Canvas pulses with the current Martigli snapshot; video engines will hook here.</p>
            </div>
          </div>
          <p class="muted-text small">
            Live Martigli controls are available directly on the Martigli / Breathing Oscillations dashboard card.
          </p>
        </section>

        <section class="modal-card" id="audio-card" aria-labelledby="audio-card-label">
          <div class="section-head">
            <div>
              <h4 id="audio-card-label">Audio tracks</h4>
              <p id="audio-track-hint" class="muted-text"></p>
            </div>
          </div>
          <ul id="audio-track-list" class="track-list"></ul>
        </section>

        <section class="modal-card" id="video-card" aria-labelledby="video-card-label">
          <div class="section-head">
            <div>
              <h4 id="video-card-label">Visual controls</h4>
              <p id="video-track-hint" class="muted-text">No video tracks stored yet.</p>
            </div>
          </div>
          <ul id="video-track-list" class="track-list"></ul>
        </section>

        <section class="modal-card" id="haptics-card" aria-labelledby="haptics-card-label">
          <div class="section-head">
            <div>
              <h4 id="haptics-card-label">Haptic controls</h4>
              <p id="haptic-track-hint" class="muted-text">No haptic tracks stored yet.</p>
            </div>
          </div>
          <ul id="haptic-track-list" class="track-list"></ul>
        </section>

        <section class="modal-card" id="structure-section" aria-labelledby="structure-label">
          <div class="section-head">
            <div>
              <h4 id="structure-label">Change-Ringing Structures</h4>
              <p id="structure-summary" class="muted-text"></p>
            </div>
          </div>
          <ul id="structure-list" class="structure-list"></ul>
        </section>
      </div>
    </section>

    <section id="visualizer-modal" class="modal hidden" aria-hidden="true">
      <div id="visualizer-overlay" class="modal-overlay" role="presentation"></div>
      <div class="modal-panel visualizer-panel" role="dialog" aria-modal="true" aria-labelledby="visualizer-title">
        <header class="modal-head">
          <h3 id="visualizer-title">Track Preview</h3>
          <button type="button" id="visualizer-close" class="ghost small" aria-label="Close visualizer">Close</button>
        </header>
        <canvas id="visualizer-canvas" width="760" height="280" aria-label="Expanded track visualization"></canvas>
        <p id="visualizer-summary" class="muted-text small"></p>
      </div>
    </section>

    <script type="module" src="scripts/auth.js"></script>
    <script type="module" src="scripts/nso-navigator.js"></script>
  </body>
</html>
