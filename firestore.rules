rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Sessions Collection
    // Users can only read/write their own sessions
    match /sessions/{sessionId} {
      allow read: if isAuthenticated() &&
                     (resource.data.createdBy == request.auth.uid ||
                      resource.data.sharedWith != null && request.auth.uid in resource.data.sharedWith);

      allow create: if isAuthenticated() &&
                       request.resource.data.createdBy == request.auth.uid &&
                       request.resource.data.createdAt is timestamp;

      allow update: if isAuthenticated() &&
                       resource.data.createdBy == request.auth.uid &&
                       request.resource.data.createdBy == resource.data.createdBy; // Can't change owner

      allow delete: if isAuthenticated() &&
                       resource.data.createdBy == request.auth.uid;
    }

    // Telemetry Collection
    // Any authenticated user can write telemetry
    // Only admins can read (for privacy)
    match /telemetry/{eventId} {
      allow read: if false; // TODO: Add admin check when admin system is implemented
      allow create: if isAuthenticated() &&
                       request.resource.data.recordedAt is timestamp;
      allow update, delete: if false; // Telemetry is append-only
    }

    // Shared States Collection (for URL sharing)
    // Anyone can read shared states (they're meant to be public)
    // Authenticated users can create shared states
    // Only creator can delete (cleanup)
    match /shared-states/{stateId} {
      allow read: if true; // Public read for shared URLs

      allow create: if isAuthenticated() &&
                       request.resource.data.createdAt is timestamp &&
                       request.resource.data.expiresAt is timestamp;

      allow update: if false; // Shared states are immutable

      allow delete: if isAuthenticated() &&
                       resource.data.createdBy == request.auth.uid;
    }

    // User Profiles Collection
    // Users can only read/write their own profile
    match /user-profiles/{userId} {
      allow read: if isOwner(userId);

      allow create: if isOwner(userId) &&
                       request.resource.data.createdAt is timestamp;

      allow update: if isOwner(userId);

      allow delete: if isOwner(userId);
    }

    // Presets Collection
    // Community presets are public read
    // Users can create/modify their own presets
    match /presets/{presetId} {
      allow read: if resource.data.visibility == 'public' ||
                     (isAuthenticated() && resource.data.createdBy == request.auth.uid);

      allow create: if isAuthenticated() &&
                       request.resource.data.createdBy == request.auth.uid &&
                       request.resource.data.createdAt is timestamp;

      allow update: if isAuthenticated() &&
                       resource.data.createdBy == request.auth.uid &&
                       request.resource.data.createdBy == resource.data.createdBy; // Can't change owner

      allow delete: if isAuthenticated() &&
                       resource.data.createdBy == request.auth.uid;
    }

    // Deny all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
